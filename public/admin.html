<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, .1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-slate-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <h1 class="text-2xl font-bold mb-6 text-slate-800 text-center">Admin Login</h1>
            <div class="space-y-4">
                <div>
                    <label for="admin-secret" class="block text-sm font-medium text-slate-700">Admin Secret Key:</label>
                    <input type="password" id="admin-secret" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" placeholder="••••••••••">
                </div>
                <button id="login-btn" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    <span id="login-btn-text">Log In</span>
                    <div id="login-spinner" class="spinner hidden"></div>
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center h-4"></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
        <div class="flex flex-col md:flex-row h-screen bg-slate-200">
            <!-- Mobile Header -->
            <header class="md:hidden bg-slate-800 text-white p-4 flex justify-between items-center sticky top-0 z-10">
                <div class="text-xl font-bold">APCMB Admin</div>
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
            </header>
            
            <!-- Sidebar -->
            <aside id="sidebar" class="w-full md:w-64 bg-slate-800 text-slate-200 flex-col fixed md:relative inset-y-0 left-0 transform md:transform-none -translate-x-full transition-transform duration-200 ease-in-out z-20 flex">
                <div class="p-4 text-2xl font-bold border-b border-slate-700 hidden md:flex items-center justify-between">
                    <span>APCMB Admin</span>
                </div>
                <nav class="flex-1 p-2 space-y-1">
                    <a href="#" data-view="dashboard" class="sidebar-link active flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-tachometer-alt fa-fw"></i> Dashboard</a>
                    <a href="#" data-view="withdrawals" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-hand-holding-usd fa-fw"></i> Withdrawals</a>
                    <a href="#" data-view="owners" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-users fa-fw"></i> Owners</a>
                    <a href="#" data-view="reports" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-flag fa-fw"></i> Reports</a>
                </nav>
                <div class="p-4 border-t border-slate-700">
                    <button id="logout-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 text-sm font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Log Out
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="view space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow space-y-4"><h3 class="text-slate-500 font-bold">Sales Overview</h3><div class="flex justify-between items-center"><span class="text-sm">Total Owners</span> <span id="stats-owners" class="font-bold">...</span></div><div class="flex justify-between items-center"><span class="text-sm">Total Channels</span> <span id="stats-channels" class="font-bold">...</span></div><hr><div class="flex justify-between items-center"><span class="text-sm">Total Revenue</span> <span id="stats-revenue" class="font-bold text-lg">...</span></div></div>
                            <div class="bg-white p-6 rounded-lg shadow space-y-4"><h3 class="text-green-600 font-bold">Your Earnings</h3><div class="flex justify-between items-center"><span class="text-sm">My Commission</span> <span id="stats-commission" class="font-bold text-green-600 text-lg">...</span></div></div>
                            <div class="bg-white p-6 rounded-lg shadow space-y-4"><h3 class="text-blue-600 font-bold">Financials</h3><div class="flex justify-between items-center"><span class="text-sm">Total Paid to Owners</span> <span id="stats-paid-out" class="font-bold text-red-500 text-lg">...</span></div><div class="flex justify-between items-center"><span class="text-sm">Pending Payouts</span> <span id="stats-pending-payouts" class="font-bold text-orange-500 text-lg">...</span></div></div>
                        </div>
                    </div>
                    <!-- Withdrawals View -->
                    <div id="withdrawals-view" class="view hidden"><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-2xl font-bold mb-4">Pending Withdrawal Requests</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Owner</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Amount</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">UPI ID</th><th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase">Actions</th></tr></thead><tbody id="withdrawals-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div>
                    <!-- Owners View -->
                    <div id="owners-view" class="view hidden"><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-2xl font-bold mb-4">All Channel Owners</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Owner Details</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Wallet</th><th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase">Actions</th></tr></thead><tbody id="owners-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div>
                    <!-- Reports View -->
                    <div id="reports-view" class="view hidden"><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-2xl font-bold mb-4">User Reports</h2><div id="reports-container" class="space-y-4"></div></div></div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="inspect-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg"><div class="p-4 border-b flex justify-between items-center"><h3 class="text-xl font-bold" id="modal-owner-name">Owner's Channels</h3><button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div class="p-4"><table class="min-w-full"><tbody id="modal-channels-table"></tbody></table></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginScreen = document.getElementById('login-screen'); const dashboardScreen = document.getElementById('dashboard-screen'); const secretInput = document.getElementById('admin-secret'); const loginBtn = document.getElementById('login-btn'); const loginBtnText = document.getElementById('login-btn-text'); const loginSpinner = document.getElementById('login-spinner'); const loginError = document.getElementById('login-error'); const logoutBtns = document.querySelectorAll('#logout-btn'); const sidebar = document.getElementById('sidebar'); const mobileMenuBtn = document.getElementById('mobile-menu-btn'); const sidebarLinks = document.querySelectorAll('.sidebar-link'); const views = document.querySelectorAll('.view'); const inspectModal = document.getElementById('inspect-modal'); const modalCloseBtn = document.getElementById('modal-close-btn'); const modalOwnerName = document.getElementById('modal-owner-name'); const modalChannelsTable = document.getElementById('modal-channels-table'); const reportsContainer = document.getElementById('reports-container'); let adminSecret = '';
            const fetchData = async (url) => { const r = await fetch(`${url}?secret=${adminSecret}`); if (!r.ok) throw new Error(await r.text() || 'API Error'); return r.json(); };
            const postData = async (url, body = {}) => { const r = await fetch(`${url}?secret=${adminSecret}`,{method:'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)}); if (!r.ok) throw new Error(await r.text() || 'API Error'); return r.json(); };
            const loadStats = async () => { try { const s = await fetchData('/api/super/stats'); document.getElementById('stats-owners').textContent = s.totalOwners; document.getElementById('stats-channels').textContent = s.totalChannels; document.getElementById('stats-revenue').textContent = `₹${(s.totalRevenue || 0).toFixed(2)}`; document.getElementById('stats-commission').textContent = `₹${(s.totalCommission || 0).toFixed(2)}`; document.getElementById('stats-paid-out').textContent = `₹${(s.totalPaidOut || 0).toFixed(2)}`; document.getElementById('stats-pending-payouts').textContent = `₹${(s.pendingPayouts || 0).toFixed(2)}`; } catch(e){ console.error("Stats Error:", e) } };
            const loadWithdrawals = async () => { const t = document.getElementById('withdrawals-table-body'); t.innerHTML = `<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>`; try { const r=await fetchData('/api/super/withdrawals'); if(r.length===0){t.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-slate-500">No pending requests.</td></tr>`} else { t.innerHTML=''; r.forEach(req => {t.innerHTML+=`<tr><td class="px-6 py-4">${req.owner_id.first_name} (${req.owner_id.telegram_id})</td><td class="px-6 py-4 font-bold">₹${req.amount.toFixed(2)}</td><td class="px-6 py-4">${req.upi_id}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${req._id}" class="approve-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Approve</button><button data-id="${req._id}" class="reject-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Reject</button></td></tr>`}) } } catch(e){ console.error("Withdrawals Error:", e) }};
            const loadOwners = async () => { const t = document.getElementById('owners-table-body'); t.innerHTML = `<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>`; try { const o=await fetchData('/api/super/owners'); if(o.length===0){t.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-slate-500">No owners registered.</td></tr>`} else { t.innerHTML=''; o.forEach(owner => { const s=owner.is_banned?`<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Banned</span>`:`<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>`; const b=!owner.is_banned?`<button data-owner-id="${owner._id}" data-owner-name="${owner.first_name}" class="ban-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Ban</button>`:''; t.innerHTML+=`<tr><td class="px-6 py-4"><div class="font-bold">${owner.first_name||'N/A'}</div><div class="text-sm text-slate-500">${owner.telegram_id}</div></td><td class="px-6 py-4">${s}</td><td class="px-6 py-4 font-bold text-green-600">₹${(owner.wallet_balance||0).toFixed(2)}</td><td class="px-6 py-4 text-center space-x-2"><button data-owner-id="${owner._id}" data-owner-name="${owner.first_name}" class="inspect-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Inspect</button>${b}</td></tr>`}) } } catch(e){ console.error("Owners Error:", e) }};
            const loadReports = async () => { reportsContainer.innerHTML = '<p class="text-slate-500">Loading reports...</p>'; try { const reports = await fetchData('/api/super/reports'); if (reports.length === 0) { reportsContainer.innerHTML = '<p class="text-slate-500">No pending reports found.</p>'; } else { reportsContainer.innerHTML = ''; reports.forEach(report => { const reportCard = `<div class="border rounded-lg p-4 bg-slate-50"><p><strong>Reported Channel:</strong> ${report.reported_channel_id.channel_name}</p><p><strong>Reported Owner:</strong> ${report.reported_owner_id.first_name} (${report.reported_owner_id.telegram_id})</p><p><strong>Reporter:</strong> ${report.reporter_id}</p><p class="mt-2 p-2 bg-slate-200 rounded"><strong>Reason:</strong> ${report.reason}</p></div>`; reportsContainer.innerHTML += reportCard; }); } } catch (e) { console.error("Reports Error:", e); reportsContainer.innerHTML = '<p class="text-red-500">Failed to load reports.</p>'; }};
            const showDashboard = () => { loginScreen.classList.add('hidden'); dashboardScreen.classList.remove('hidden'); loadStats(); loadWithdrawals(); loadOwners(); };
            const showLogin = () => { loginScreen.classList.remove('hidden'); dashboardScreen.classList.add('hidden'); };
            const handleLogin = async () => { const s = secretInput.value; if (!s) { loginError.textContent = 'Please enter a secret key.'; return; } loginError.textContent = ''; loginBtnText.classList.add('hidden'); loginSpinner.classList.remove('hidden'); loginBtn.disabled = true; adminSecret = s; try { await fetchData('/api/super/stats'); localStorage.setItem('adminSecretKey', s); showDashboard(); } catch (err) { loginError.textContent = "Invalid Secret Key."; localStorage.removeItem('adminSecretKey');} finally { loginBtnText.classList.remove('hidden'); loginSpinner.classList.add('hidden'); loginBtn.disabled = false; } };
            const handleLogout = () => { localStorage.removeItem('adminSecretKey'); adminSecret = ''; secretInput.value = ''; showLogin(); };
            const handleNavigation = (e) => { e.preventDefault(); const viewId = e.currentTarget.dataset.view; views.forEach(v => v.classList.add('hidden')); document.getElementById(`${viewId}-view`).classList.remove('hidden'); sidebarLinks.forEach(l => l.classList.remove('active')); e.currentTarget.classList.add('active'); if (window.innerWidth < 768) sidebar.classList.add('-translate-x-full'); if (viewId === 'reports') loadReports(); };
            const handleActionClick = async (e) => { const btn=e.target.closest('button'); if(!btn) return; const id=btn.dataset.id; if(!id) return; const action=btn.matches('.approve-btn')?'approve':'reject'; if(!confirm(`Sure to ${action} this?`))return; btn.disabled=true; const txt=btn.textContent; btn.textContent='...'; try{ await postData(`/api/super/withdrawals/${id}/${action}`); alert(`Request ${action}d!`); await Promise.all([loadWithdrawals(), loadStats(), loadOwners()]); } catch(err){ alert(`Failed to ${action}: ${err.message}`); btn.disabled=false; btn.textContent=txt; }};
            const handleOwnerActionClick = async(e) => { const inspectBtn=e.target.closest('button.inspect-btn'); const banBtn=e.target.closest('button.ban-btn'); if(inspectBtn){ const ownerId=inspectBtn.dataset.ownerId; const ownerName=inspectBtn.dataset.ownerName; modalOwnerName.textContent=`${ownerName}'s Channels`; modalChannelsTable.innerHTML='<tr><td>Loading...</td></tr>'; inspectModal.classList.remove('hidden'); try{ const channels = await fetchData(`/api/super/owners/${ownerId}/channels`); modalChannelsTable.innerHTML=''; if(channels.length===0){modalChannelsTable.innerHTML='<tr><td>This owner has no channels.</td></tr>'}else{channels.forEach(ch=>{modalChannelsTable.innerHTML+=`<tr><td class="py-2">${ch.channel_name}</td><td class="py-2 text-right"><button data-channel-id="${ch._id}" class="get-inspect-link-btn bg-purple-500 text-white px-3 py-1 rounded-md text-sm">Get Invite Link</button></td></tr>`})} } catch(e){ alert('Failed to load channels.') } } if(banBtn){ const ownerId=banBtn.dataset.ownerId; const ownerName=banBtn.dataset.ownerName; if(confirm(`⚠️ ARE YOU ABSOLUTELY SURE? ⚠️\n\nThis will ban "${ownerName}" and remove all their channels. This cannot be undone.`)){banBtn.disabled=true; banBtn.textContent='Banning...'; try{ const res = await postData(`/api/super/owners/${ownerId}/ban`); alert(res.message); await loadOwners(); } catch(err){ alert(`Failed to ban owner: ${err.message}`); banBtn.disabled=false; banBtn.textContent = 'Ban'; }} }};
            const handleGetInspectLink = async (e) => { const btn = e.target.closest('button.get-inspect-link-btn'); if(!btn) return; btn.disabled = true; btn.textContent='...'; try { const res = await postData(`/api/super/channels/${btn.dataset.channelId}/inspect`); alert(res.message); } catch(err){ alert(`Error: ${err.message}`); } finally { btn.disabled=false; btn.textContent = 'Get Invite Link'; }};
            loginBtn.addEventListener('click', handleLogin);
            secretInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            logoutBtns.forEach(btn => btn.addEventListener('click', handleLogout)); sidebarLinks.forEach(link => link.addEventListener('click', handleNavigation)); mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
            document.getElementById('withdrawals-table-body').addEventListener('click', handleActionClick);
            document.getElementById('owners-table-body').addEventListener('click', handleOwnerActionClick);
            modalCloseBtn.addEventListener('click', () => inspectModal.classList.add('hidden'));
            modalChannelsTable.addEventListener('click', handleGetInspectLink);
            const savedSecret = localStorage.getItem('adminSecretKey');
            if (savedSecret) { adminSecret = savedSecret; showDashboard(); }
        });
    </script>
</body>
</html>

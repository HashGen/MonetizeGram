<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, .1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 space-y-8">
        
        <!-- HEADER: Title, Login Form, and Logout Button -->
        <div id="header-section">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-900">Super Admin Dashboard</h1>
                <button id="logout-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Log Out</button>
            </div>
            <div id="login-section">
                <label for="admin-secret" class="block text-sm font-medium text-gray-700">Admin Secret Key:</label>
                <input type="password" id="admin-secret" class="mt-1 block w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter your secret key to load data">
            </div>
        </div>

        <!-- MAIN CONTENT: This will be shown after login -->
        <div id="main-content" class="hidden space-y-8">
            <!-- Stats Section -->
            <div id="stats-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">Total Owners</h3><p id="stats-owners" class="text-3xl font-bold">0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">Total Channels</h3><p id="stats-channels" class="text-3xl font-bold">0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">Total Revenue</h3><p id="stats-revenue" class="text-3xl font-bold">₹0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">My Commission</h3><p id="stats-commission" class="text-3xl font-bold">₹0</p></div>
            </div>

            <!-- Withdrawal Requests Section -->
            <div id="withdrawals-section" class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Pending Withdrawal Requests</h2>
                    <button id="refresh-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Refresh</button>
                </div>
                <div id="loader-withdrawals" class="flex justify-center my-8 hidden"><div class="spinner"></div></div>
                <p id="withdrawals-message" class="text-center text-gray-500 my-8"></p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">UPI ID</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="withdrawals-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                </div>
            </div>
            
            <!-- Owners List Section -->
            <div id="owners-section" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">All Channel Owners</h2>
                <div id="loader-owners" class="flex justify-center my-8 hidden"><div class="spinner"></div></div>
                <p id="owners-message" class="text-center text-gray-500 my-8"></p>
                 <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner Details</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wallet Balance</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Earnings</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registered On</th></tr></thead><tbody id="owners-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const secretInput = document.getElementById('admin-secret');
            const loginSection = document.getElementById('login-section');
            const mainContent = document.getElementById('main-content');
            const logoutBtn = document.getElementById('logout-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            let adminSecret = '';

            // --- API HELPER FUNCTIONS ---
            const fetchData = async (url) => { /* ... no change ... */ };
            const postData = async (url) => { /* ... no change ... */ };

            // --- DATA LOADING FUNCTIONS ---
            const loadStats = async () => { /* ... no change ... */ };
            const loadWithdrawals = async () => { /* ... no change ... */ };
            const loadOwners = async () => { /* ... no change ... */ };
            const loadAllData = async () => { /* ... no change ... */ };
            
            // --- NEW LOGIN & UI FUNCTIONS ---
            const showDashboard = () => {
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                loadAllData();
            };
            
            const showLogin = () => {
                loginSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            };

            // --- EVENT LISTENERS ---
            secretInput.addEventListener('change', (e) => {
                const enteredSecret = e.target.value;
                if (enteredSecret) {
                    adminSecret = enteredSecret;
                    // Test the secret by trying to fetch stats
                    loadStats().then(() => {
                        // If successful, save to localStorage and show dashboard
                        localStorage.setItem('adminSecretKey', enteredSecret);
                        showDashboard();
                    }).catch(err => {
                        alert("Invalid Secret Key!");
                        e.target.value = '';
                    });
                }
            });

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('adminSecretKey');
                adminSecret = '';
                showLogin();
                // Optional: reload the page for a cleaner state
                // window.location.reload(); 
            });

            refreshBtn.addEventListener('click', loadAllData);
            document.getElementById('withdrawals-table-body').addEventListener('click', (e) => { /* handleActionClick logic here */ });

            // --- ON PAGE LOAD ---
            const savedSecret = localStorage.getItem('adminSecretKey');
            if (savedSecret) {
                adminSecret = savedSecret;
                secretInput.value = savedSecret; // Optional: fill the input
                showDashboard();
            }

            // --- Copy-paste the unchanged functions here ---
            fetchData = async (url) => {
                const response = await fetch(`${url}?secret=${adminSecret}`);
                if (!response.ok) throw new Error(await response.text() || `HTTP error! status: ${response.status}`);
                return response.json();
            };
            postData = async (url) => {
                const response = await fetch(`${url}?secret=${adminSecret}`, { method: 'POST' });
                if (!response.ok) throw new Error(await response.text() || `HTTP error! status: ${response.status}`);
                return response.json();
            };
            loadStats = async () => {
                const stats = await fetchData('/api/super/stats');
                document.getElementById('stats-owners').textContent = stats.totalOwners;
                document.getElementById('stats-channels').textContent = stats.totalChannels;
                document.getElementById('stats-revenue').textContent = `₹${(stats.totalRevenue || 0).toFixed(2)}`;
                document.getElementById('stats-commission').textContent = `₹${(stats.totalCommission || 0).toFixed(2)}`;
            };
            loadWithdrawals = async () => {
                const tableBody = document.getElementById('withdrawals-table-body');
                const messageEl = document.getElementById('withdrawals-message');
                tableBody.innerHTML = '';
                document.getElementById('loader-withdrawals').classList.remove('hidden');
                messageEl.textContent = '';
                try {
                    const requests = await fetchData('/api/super/withdrawals');
                    if (requests.length === 0) messageEl.textContent = 'No pending withdrawal requests found.';
                    requests.forEach(req => {
                        const row = `<tr><td class="px-6 py-4">${req.owner_id.first_name} (${req.owner_id.telegram_id})</td><td class="px-6 py-4 font-bold">₹${req.amount.toFixed(2)}</td><td class="px-6 py-4">${req.upi_id}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${req._id}" class="approve-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Approve</button><button data-id="${req._id}" class="reject-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Reject</button></td></tr>`;
                        tableBody.innerHTML += row;
                    });
                } finally {
                    document.getElementById('loader-withdrawals').classList.add('hidden');
                }
            };
            loadOwners = async () => {
                const tableBody = document.getElementById('owners-table-body');
                const messageEl = document.getElementById('owners-message');
                tableBody.innerHTML = '';
                document.getElementById('loader-owners').classList.remove('hidden');
                messageEl.textContent = '';
                try {
                    const owners = await fetchData('/api/super/owners');
                    if (owners.length === 0) messageEl.textContent = 'No owners have registered yet.';
                    owners.forEach(owner => {
                        const row = `<tr><td class="px-6 py-4"><div class="font-bold">${owner.first_name || 'N/A'}</div><div class="text-sm text-gray-500">${owner.telegram_id}</div></td><td class="px-6 py-4 font-bold text-green-600">₹${(owner.wallet_balance || 0).toFixed(2)}</td><td class="px-6 py-4">₹${(owner.total_earnings || 0).toFixed(2)}</td><td class="px-6 py-4 text-sm text-gray-500">${new Date(owner.created_at).toLocaleDateString()}</td></tr>`;
                        tableBody.innerHTML += row;
                    });
                } finally {
                    document.getElementById('loader-owners').classList.add('hidden');
                }
            };
            loadAllData = async () => {
                await Promise.all([loadStats(), loadWithdrawals(), loadOwners()]);
            };
            document.getElementById('withdrawals-table-body').addEventListener('click', async (e) => {
                const button = e.target.closest('button'); if (!button) return;
                const id = button.dataset.id; if (!id) return;
                const action = button.matches('.approve-btn') ? 'approve' : 'reject';
                if (!confirm(`Are you sure you want to ${action} this request?`)) return;
                button.disabled = true; const originalText = button.textContent; button.textContent = 'Processing...';
                try {
                    await postData(`/api/super/withdrawals/${id}/${action}`);
                    alert(`Request ${action}d successfully!`);
                    await loadWithdrawals();
                } catch (error) {
                    alert(`Failed to ${action}: ` + error.message);
                    button.disabled = false; button.textContent = originalText;
                }
            });
        });
    </script>
</body>
</html>

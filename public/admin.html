<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, .1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-slate-200 p-4">
        <!-- ... Login form remains the same ... -->
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
        <div class="flex flex-col md:flex-row h-screen bg-slate-200">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-full md:w-64 bg-slate-800 text-slate-200 flex-col ...">
                <!-- ... Sidebar remains the same ... -->
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="view space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Sales Stats -->
                            <div class="bg-white p-6 rounded-lg shadow space-y-4">
                                <h3 class="text-slate-500 font-bold">Sales Overview</h3>
                                <div class="flex justify-between items-center"><span class="text-sm">Total Owners</span> <span id="stats-owners" class="font-bold">...</span></div>
                                <div class="flex justify-between items-center"><span class="text-sm">Total Channels</span> <span id="stats-channels" class="font-bold">...</span></div>
                                <hr>
                                <div class="flex justify-between items-center"><span class="text-sm">Total Revenue</span> <span id="stats-revenue" class="font-bold text-lg">...</span></div>
                            </div>
                            <!-- Your Earnings -->
                            <div class="bg-white p-6 rounded-lg shadow space-y-4">
                                <h3 class="text-green-600 font-bold">Your Earnings</h3>
                                <div class="flex justify-between items-center"><span class="text-sm">My Commission</span> <span id="stats-commission" class="font-bold text-green-600 text-lg">...</span></div>
                                <!-- You can add more of your specific stats here in the future -->
                            </div>
                            <!-- Payouts / Financials -->
                            <div class="bg-white p-6 rounded-lg shadow space-y-4">
                                <h3 class="text-blue-600 font-bold">Financials</h3>
                                <div class="flex justify-between items-center"><span class="text-sm">Total Paid to Owners</span> <span id="stats-paid-out" class="font-bold text-red-500 text-lg">...</span></div>
                                <div class="flex justify-between items-center"><span class="text-sm">Pending Payouts</span> <span id="stats-pending-payouts" class="font-bold text-orange-500 text-lg">...</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- Other Views (Withdrawals, Owners) -->
                    <div id="withdrawals-view" class="view hidden"> <!-- ... no change ... --> </div>
                    <div id="owners-view" class="view hidden"> <!-- ... no change ... --> </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (most of the script remains the same)

            // --- DATA LOADERS (Only loadStats is changed) ---
            const loadStats = async () => {
                try {
                    const stats = await fetchData('/api/super/stats');
                    // Sales Overview
                    document.getElementById('stats-owners').textContent = stats.totalOwners;
                    document.getElementById('stats-channels').textContent = stats.totalChannels;
                    document.getElementById('stats-revenue').textContent = `₹${(stats.totalRevenue || 0).toFixed(2)}`;
                    
                    // Your Earnings
                    document.getElementById('stats-commission').textContent = `₹${(stats.totalCommission || 0).toFixed(2)}`;
                    
                    // --- NEW FINANCIAL STATS ---
                    document.getElementById('stats-paid-out').textContent = `₹${(stats.totalPaidOut || 0).toFixed(2)}`;
                    document.getElementById('stats-pending-payouts').textContent = `₹${(stats.pendingPayouts || 0).toFixed(2)}`;

                } catch (e) { console.error("Stats Error:", e); }
            };
            
            // ... (rest of the script remains the same)
        });
    </script>
    
    <!-- This is the full HTML, I've just hidden unchanged parts for brevity. The full code is below -->
    <!-- FULL HTML/JS Code -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-slate-200 p-4"><div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"><h1 class="text-2xl font-bold mb-6 text-slate-800 text-center">Admin Login</h1><div class="space-y-4"><div><label for="admin-secret" class="block text-sm font-medium text-slate-700">Admin Secret Key:</label><input type="password" id="admin-secret" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" placeholder="••••••••••"></div><button id="login-btn" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"><span id="login-btn-text">Log In</span><div id="login-spinner" class="spinner hidden"></div></button><p id="login-error" class="text-red-500 text-sm text-center h-4"></p></div></div></div>
    <div id="dashboard-screen" class="hidden"><div class="flex flex-col md:flex-row h-screen bg-slate-200"><header class="md:hidden bg-slate-800 text-white p-4 flex justify-between items-center"><div class="text-xl font-bold">APCMB Admin</div><button id="mobile-menu-btn"><i class="fas fa-bars"></i></button></header><aside id="sidebar" class="w-full md:w-64 bg-slate-800 text-slate-200 flex-col absolute md:relative inset-y-0 left-0 transform md:transform-none -translate-x-full transition-transform duration-200 ease-in-out z-20 flex"><div class="p-4 text-2xl font-bold border-b border-slate-700 hidden md:block">APCMB Admin</div><nav class="flex-1 p-2 space-y-1"><a href="#" data-view="dashboard" class="sidebar-link active flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-tachometer-alt fa-fw"></i> Dashboard</a><a href="#" data-view="withdrawals" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-hand-holding-usd fa-fw"></i> Withdrawals</a><a href="#" data-view="owners" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700"><i class="fas fa-users fa-fw"></i> Owners</a></nav><div class="p-4 border-t border-slate-700"><button id="logout-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 text-sm font-medium flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Log Out</button></div></aside><main class="flex-1 flex flex-col overflow-hidden"><div class="flex-1 p-4 md:p-6 overflow-y-auto"><div id="dashboard-view" class="view space-y-6"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow space-y-4"><h3 class="text-slate-500 font-bold">Sales Overview</h3><div class="flex justify-between items-center"><span class="text-sm">Total Owners</span> <span id="stats-owners" class="font-bold">...</span></div><div class="flex justify-between items-center"><span class="text-sm">Total Channels</span> <span id="stats-channels" class="font-bold">...</span></div><hr><div class="flex justify-between items-center"><span class="text-sm">Total Revenue</span> <span id="stats-revenue" class="font-bold text-lg">...</span></div></div><div class="bg-white p-6 rounded-lg shadow space-y-4"><h3 class="text-green-600 font-bold">Your Earnings</h3><div class="flex justify-between items-center"><span class="text-sm">My Commission</span> <span id="stats-commission" class="font-bold text-green-600 text-lg">...</span></div></div><div class="bg-white p-6 rounded-lg shadow space-y-4"><h3 class="text-blue-600 font-bold">Financials</h3><div class="flex justify-between items-center"><span class="text-sm">Total Paid to Owners</span> <span id="stats-paid-out" class="font-bold text-red-500 text-lg">...</span></div><div class="flex justify-between items-center"><span class="text-sm">Pending Payouts</span> <span id="stats-pending-payouts" class="font-bold text-orange-500 text-lg">...</span></div></div></div></div><div id="withdrawals-view" class="view hidden"><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-2xl font-bold mb-4">Pending Withdrawal Requests</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Owner</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Amount</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">UPI ID</th><th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase">Actions</th></tr></thead><tbody id="withdrawals-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div><div id="owners-view" class="view hidden"><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-2xl font-bold mb-4">All Channel Owners</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Owner Details</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Wallet Balance</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Total Earnings</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Registered On</th></tr></thead><tbody id="owners-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div></div></main></div></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => { const loginScreen = document.getElementById('login-screen'), dashboardScreen = document.getElementById('dashboard-screen'); const secretInput = document.getElementById('admin-secret'), loginBtn = document.getElementById('login-btn'); const loginBtnText = document.getElementById('login-btn-text'), loginSpinner = document.getElementById('login-spinner'), loginError = document.getElementById('login-error'); const logoutBtns = document.querySelectorAll('#logout-btn'), sidebar = document.getElementById('sidebar'), mobileMenuBtn = document.getElementById('mobile-menu-btn'); const sidebarLinks = document.querySelectorAll('.sidebar-link'), views = document.querySelectorAll('.view'); let adminSecret = ''; const fetchData = async (url) => { const r = await fetch(`${url}?secret=${adminSecret}`); if (!r.ok) throw new Error(await r.text() || 'API Error'); return r.json(); }; const postData = async (url) => { const r = await fetch(`${url}?secret=${adminSecret}`,{method:'POST'}); if (!r.ok) throw new Error(await r.text() || 'API Error'); return r.json(); }; const loadStats = async () => { try{ const s = await fetchData('/api/super/stats'); document.getElementById('stats-owners').textContent = s.totalOwners; document.getElementById('stats-channels').textContent = s.totalChannels; document.getElementById('stats-revenue').textContent = `₹${(s.totalRevenue || 0).toFixed(2)}`; document.getElementById('stats-commission').textContent = `₹${(s.totalCommission || 0).toFixed(2)}`; document.getElementById('stats-paid-out').textContent = `₹${(s.totalPaidOut || 0).toFixed(2)}`; document.getElementById('stats-pending-payouts').textContent = `₹${(s.pendingPayouts || 0).toFixed(2)}`;} catch(e){ console.error("Stats Error:", e) } }; const loadWithdrawals = async () => { try{ const t = document.getElementById('withdrawals-table-body'); t.innerHTML = `<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>`; const r=await fetchData('/api/super/withdrawals'); if(r.length===0){t.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-slate-500">No pending requests.</td></tr>`} else { t.innerHTML=''; r.forEach(req => {t.innerHTML+=`<tr><td class="px-6 py-4">${req.owner_id.first_name} (${req.owner_id.telegram_id})</td><td class="px-6 py-4 font-bold">₹${req.amount.toFixed(2)}</td><td class="px-6 py-4">${req.upi_id}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${req._id}" class="approve-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Approve</button><button data-id="${req._id}" class="reject-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Reject</button></td></tr>`}) } } catch(e){ console.error("Withdrawals Error:", e) }}; const loadOwners = async () => { try { const t = document.getElementById('owners-table-body'); t.innerHTML = `<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>`; const o=await fetchData('/api/super/owners'); if(o.length===0){t.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-slate-500">No owners registered.</td></tr>`} else { t.innerHTML=''; o.forEach(owner => {t.innerHTML+=`<tr><td class="px-6 py-4"><div class="font-bold">${owner.first_name||'N/A'}</div><div class="text-sm text-slate-500">${owner.telegram_id}</div></td><td class="px-6 py-4 font-bold text-green-600">₹${(owner.wallet_balance||0).toFixed(2)}</td><td class="px-6 py-4">₹${(owner.total_earnings||0).toFixed(2)}</td><td class="px-6 py-4 text-sm text-slate-500">${new Date(owner.created_at).toLocaleDateString()}</td></tr>`}) } } catch(e){ console.error("Owners Error:", e) }}; const showDashboard = () => { loginScreen.classList.add('hidden'); dashboardScreen.classList.remove('hidden'); loadStats(); loadWithdrawals(); loadOwners(); }; const showLogin = () => { loginScreen.classList.remove('hidden'); dashboardScreen.classList.add('hidden'); }; const handleLogin = async () => { const s = secretInput.value; if (!s) { loginError.textContent = 'Please enter a secret key.'; return; } loginError.textContent = ''; loginBtnText.classList.add('hidden'); loginSpinner.classList.remove('hidden'); loginBtn.disabled = true; adminSecret = s; try { await fetchData('/api/super/stats'); localStorage.setItem('adminSecretKey', s); showDashboard(); } catch (err) { loginError.textContent = "Invalid Secret Key."; localStorage.removeItem('adminSecretKey');} finally { loginBtnText.classList.remove('hidden'); loginSpinner.classList.add('hidden'); loginBtn.disabled = false; } }; const handleLogout = () => { localStorage.removeItem('adminSecretKey'); adminSecret = ''; secretInput.value = ''; showLogin(); }; const handleNavigation = (e) => { e.preventDefault(); const v=e.currentTarget.dataset.view; views.forEach(v => v.classList.add('hidden')); document.getElementById(`${v}-view`).classList.remove('hidden'); sidebarLinks.forEach(l => l.classList.remove('active')); e.currentTarget.classList.add('active'); if (window.innerWidth < 768) sidebar.classList.add('-translate-x-full'); }; loginBtn.addEventListener('click', handleLogin); secretInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); }); logoutBtns.forEach(btn => btn.addEventListener('click', handleLogout)); sidebarLinks.forEach(link => link.addEventListener('click', handleNavigation)); mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full')); document.getElementById('withdrawals-table-body').addEventListener('click', async (e) => { const btn=e.target.closest('button'); if(!btn) return; const id=btn.dataset.id; if(!id) return; const action=btn.matches('.approve-btn')?'approve':'reject'; if(!confirm(`Sure to ${action} this?`))return; btn.disabled=true; const txt=btn.textContent; btn.textContent='...'; try{ await postData(`/api/super/withdrawals/${id}/${action}`); alert(`Request ${action}d!`); await Promise.all([loadWithdrawals(), loadStats(), loadOwners()]); } catch(err){ alert(`Failed to ${action}`); btn.disabled=false; btn.textContent=txt; }}); const savedSecret = localStorage.getItem('adminSecretKey'); if (savedSecret) { adminSecret = savedSecret; showDashboard(); } }); </script>
</body>
</html>
